{"version":3,"file":"konvas.js","sources":["../src/dragger/index.ts","../src/dragger/isOut.ts","../src/node.ts","../src/utils/index.ts","../src/index.ts","../src/utils/dom.ts"],"sourcesContent":["import Canvas from '../index'\nimport isOut from './isOut'\n\n/**\n * Dragger\n */\nclass Dragger {\n  private canvas: Canvas\n  private opts: { onStart: any, onStop: any, onMove: any }\n  private active: any\n  private dragging: any\n  private mouse: any\n  private startPoint: any\n  private x: number | null\n  private y: number | null\n\n  constructor(canvas: Canvas, opts: any) {\n    this.canvas = canvas\n    this.opts = opts\n    this.x = 0\n    this.y = 0\n    this.initEvent()\n  }\n\n  private initEvent() {\n    this.canvas.el.addEventListener('mousedown', this.onMouseDown, false)\n    this.canvas.el.addEventListener('mouseup', this.onMouseUp, false)\n    // this.canvas.elem.addEventListener('mouseleave', this.onMouseUp, false)\n\n    document.documentElement.addEventListener('mousemove', this.onMouseMove, false)\n    document.documentElement.addEventListener('mouseup', this.onMouseUp, false)\n  }\n\n  private onMouseDown = (e: Event) => {\n    const { target } = e\n    const targetElem = target as HTMLElement\n    this.active = this.canvas.getNode(targetElem.id)\n\n    if (this.active && this.active.isDraggable) {\n      this.dragging = true\n\n      if (this.mouse && this.active) {\n        this.startPoint = {\n          x: this.mouse.x - this.active.x,\n          y: this.mouse.y - this.active.y\n        }\n      }\n      this.opts.onStart(targetElem.id)\n    }\n  }\n\n  private onMouseMove = (e: MouseEvent) => {\n    if (e.stopPropagation) {\n      e.stopPropagation()\n    }\n    if (e.preventDefault) {\n      e.preventDefault()\n    }\n\n    let x = e.pageX - this.canvas.left\n    let y = e.pageY - this.canvas.top\n\n    x = x / this.canvas.scale\n    y = y / this.canvas.scale\n\n    this.mouse = { x, y }\n\n    if (this.dragging && this.active) {\n      x = x - this.startPoint.x\n      const xStr = String(Math.round(x))\n      const yStr = String(Math.round(y - this.startPoint.y))\n      x = parseInt(xStr, 10)\n      y = parseInt(yStr, 10)\n\n      const isout = isOut(x, y, this.canvas, this.active)\n      if (isout.x >= 0 || isout.y >= 0) {\n        x = isout.x\n        y = isout.y\n      }\n      this.opts.onMove(this.active.id, { x, y })\n      this.x = x\n      this.y = y\n    }\n  }\n\n  private onMouseUp = () => {\n    if (this.dragging && this.active) {\n\n      this.dragging = false\n\n      const { id } = this.active\n\n      if (id) {\n        if (typeof this.x !== 'undefined'\n          && typeof this.y !== 'undefined') {\n          this.opts.onStop(id, { x: this.x, y: this.y })\n        }\n\n        this.x = null\n        this.y = null\n        this.active = null\n      }\n    }\n  }\n}\n\nexport default Dragger\n","export default function isOut(x: number, y: number, container: any, node: any): { x: number, y: number } {\n  let newX = x \n  let newY = y\n  if (x <= 0) {\n    newX = 0\n  }\n\n  if (y <= 0) {\n    newY = 0\n  }\n\n  if (x + node.width >= container.width) {\n    newX = container.width - node.width\n  }\n\n  if (y + node.height >= container.height) {\n    newY = container.height - node.height\n  }\n\n  return {\n    x: newX >= 0 ? newX : -1,\n    y: newY >= 0 ? newY : -1\n  }\n}\n","import { isbool } from './utils'\n\nlet uid: number = 1\n\n/**\n *\n */\nclass Node {\n  private el: Element\n  private data: any\n  public id: string\n  public x: number\n  public y: number\n  private wrapper!: HTMLElement\n  public layout: {\n    rotate: number\n  } \n\n  public isDraggable: boolean\n  public islocked: boolean\n\n  constructor(data: any) {\n    this.el = document.createElement('div')\n\n    this.id = String(uid++)\n    this.el.id = this.id\n\n    this.el.classList.add('node')\n\n    this.isDraggable = isbool(data.draggable) ? data.draggable : true\n\n    this.islocked = false\n    this.data = { ...data }\n\n    this.x = this.data.x || 0\n    this.y = this.data.y || 0\n\n    this.layout = {\n      rotate: 0\n    }\n    this.initStyle()\n    this.render()\n  }\n\n  private initStyle() {\n    const el = this.el as HTMLElement\n    el.style.position = 'absolute'\n  }\n\n  /*\n  get x(): number {\n    return 0\n  }\n\n  get y(): number {\n    return 0\n  }\n  */\n\n  get width() {\n    return this.data.width\n  }\n\n  set width(val) {\n    this.data.width = val\n  }\n\n  get height() {\n    return this.data.height\n  }\n\n  set height(val: number) {\n    this.data.height = val\n  }\n\n  set rotate(deg: number) {\n    this.layout.rotate = deg\n    const el = this.el as HTMLElement\n    el.style.transform = `rotate(${deg}deg)`\n  }\n\n  get rotate() {\n    return this.layout.rotate\n  }\n\n  get scale() {\n    return this.data.scale || 1\n  }\n\n  set scale(val) {\n    this.data.scale = val\n    this.render()\n  }\n\n  public lock() {\n    this.islocked = true\n    this.isDraggable = false\n  }\n\n  public unlock() {\n    this.islocked = false\n    this.isDraggable = true\n  }\n\n  public move(x: number, y: number) {\n    this.x = x\n    this.y = y\n    const el = this.el as HTMLElement\n    el.style.left = `${x}px`\n    el.style.top = `${y}px`\n  }\n\n  public render() {\n    const el = this.el as HTMLElement\n    const x = this.x * this.scale\n    const y = this.y * this.scale\n    const width = this.width * this.scale\n    const height = this.height * this.scale\n\n    el.style.left = `${x}px`\n    el.style.top = `${y}px`\n    el.style.width = `${width}px`\n    el.style.height = `${height}px`\n  }\n\n  public wrap(el: HTMLElement) {\n    if (this.wrapper) {\n      // noop\n    } else {\n      this.el.appendChild(el)\n      this.wrapper = el\n    }\n  }\n\n  public toJSON() {\n    return {\n      x: this.x,\n      y: this.y,\n      width: this.width,\n      height: this.height,\n      scale: this.scale\n    }\n  }\n}\n\nexport default Node\n","export function isbool(val: any): boolean {\n  return typeof val === 'boolean'\n}\n","import { query } from './utils/dom'\nimport Dragger from './dragger'\nimport Node from './node'\n\n/*\ninterface IOptions {\n  width?: number;\n  height?: number;\n}\n*/\n\nclass Konvas {\n  public el: Element\n  private options: any\n  private dragger: Dragger\n  public nodes: Node[]\n  public activeNode: Node\n  public layout: {\n    width: number,\n    height: number,\n    scale: number\n  } \n\n  constructor(el: Element | string, options = { width: 600, height: 300, scale: 1 } ) {\n    this.el = query(el)\n    this.options = options\n    this.nodes = []\n\n    this.layout = {\n      width: options.width,\n      height: options.height,\n      scale: options.scale || 1\n    }\n\n    /*\n    Object.defineProperty(this, 'scale', {\n      set(val: number) {\n        this.layout.scale = val\n      },\n      get(): any {\n        return this.layout.scale\n      }\n    }) */\n\n    this.dragger = new Dragger(this, {\n      onStart: (id: string) => {\n        const node = this.getNode(id)\n        if (node) {\n          this.activeNode = node\n        }\n        // this.resizeable.hide()\n      },\n      onMove: (id: string, { x, y }) => {\n        this.activeNode.move(x, y)\n      },\n      onStop: (id: string) => {\n        // console.log(id)\n        // this.emit('drag.end', id, { x, y })\n        // this.resizeable.move(x, y)\n      }\n    })\n    this.initStyle()\n  }\n\n  private initStyle() {\n    this.el.classList.add('konvas')\n    const elem = (this.el as HTMLElement)\n    elem.style.position = 'relative'\n    elem.style.transformOrigin = '0 0'\n\n    this.render()\n  }\n\n  public render() {\n    const elem = (this.el as HTMLElement)\n    const width = this.width * this.scale\n    const height = this.height * this.scale\n\n    elem.setAttribute('data-scale', String(this.scale))\n    elem.style.width = `${width}px`\n    elem.style.height = `${height}px`\n  }\n\n  public addNode(node: Node | any) {\n    if (node instanceof Node) {\n      this.nodes.push(node)\n    } else {\n      node = new Node(node)\n      this.el.appendChild(node.el)\n      this.nodes.push(node)\n    }\n    return node\n  }\n\n  public getNode(node: Node | string): Node | null {\n    if (typeof node === 'string') {\n      const filters = this.nodes.filter((item: any) => item.id === node)\n      return filters[0]\n    }\n    return node\n  }\n\n  get left() {\n    return this.el.getBoundingClientRect().left\n  }\n\n  get top() {\n    return this.el.getBoundingClientRect().top\n  }\n\n  get scale() {\n    return this.layout.scale\n  }\n\n  set scale(val: number) {\n    this.layout.scale = val\n    this.nodes.forEach(node => node.scale = val)\n\n    this.render()\n  }\n\n  get width(): number {\n    return this.layout.width\n  }\n\n  get height(): number {\n    return this.layout.height\n  }\n\n  public toJSON() {\n    const nodes = this.nodes.map(node => {\n      return node.toJSON()\n    })\n\n    return {\n      width: this.width,\n      height: this.height,\n      scale: this.scale,\n      nodes\n    }\n  }\n\n  public setStyle(styles: { string: string }) {\n    setStyle(this.el, styles)\n  }\n}\n\nfunction setStyle(el: Element, style: any) {\n  const elem = el as HTMLElement\n  if (style) {\n    // const styles = []\n    for (const key in style) {\n      if (key) {\n        setStyleProp(elem.style, key, style)\n      }\n    }\n  }\n}\n\nfunction setStyleProp(elem: any, key: string, style: any) {\n  elem[key] = style[key]\n}\n\nexport default Konvas\n","export function query(el: string | Element): Element {\n  if (typeof el === 'string') {\n    const node = document.querySelector(el)\n    if (!node) {\n      return document.createElement('div')\n    }\n    return node \n  } else {\n    return el\n  }\n}\n"],"names":["canvas","opts","this","e","targetElem","_this","active","getNode","id","isDraggable","dragging","mouse","startPoint","x","y","onStart","stopPropagation","preventDefault","pageX","left","pageY","top","scale","xStr","String","Math","round","yStr","isout","container","node","newX","newY","width","height","isOut","parseInt","onMove","onStop","initEvent","Dragger","el","addEventListener","onMouseDown","onMouseUp","document","documentElement","onMouseMove","uid","data","createElement","classList","add","draggable","islocked","layout","rotate","initStyle","render","Node","style","position","Object","val","deg","transform","wrapper","appendChild","elem","key","options","querySelector","query","nodes","dragger","activeNode","_a","move","Konvas","transformOrigin","setAttribute","push","filter","item","getBoundingClientRect","forEach","map","toJSON","styles","setStyleProp","setStyle"],"mappings":"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"}